name: "flowsmith: trigger on issue"

on:
  issues:
    types:
      - labeled
      - reopened

permissions:
  contents: read

concurrency:
  group: flowsmith-issue-${{ github.repository }}-${{ github.event.issue.number }}
  cancel-in-progress: true

jobs:
  dispatch:
    runs-on: ubuntu-latest
    env:
      FLOW_SMITH_REPO: ${{ vars.FLOW_SMITH_REPO || 'MasaakiAYB/FlowSmith' }}
      FLOW_SMITH_PROJECT_ID: ${{ vars.FLOW_SMITH_PROJECT_ID || '' }}
      FLOWSMITH_RUN_GATE_MODE: ${{ vars.FLOWSMITH_RUN_GATE_MODE || 'auto' }}
    steps:
      - name: Evaluate trigger gate
        id: gate
        run: |
          set -euo pipefail

          mode="${FLOWSMITH_RUN_GATE_MODE}"
          action="$(jq -r '.action // ""' "$GITHUB_EVENT_PATH")"
          labeled_name="$(jq -r '.label.name // ""' "$GITHUB_EVENT_PATH")"
          issue_labels="$(jq -c '[.issue.labels[].name] // []' "$GITHUB_EVENT_PATH")"

          has_task="false"
          has_ready="false"
          if echo "$issue_labels" | jq -e 'index("agent-task") != null' >/dev/null; then
            has_task="true"
          fi
          if echo "$issue_labels" | jq -e 'index("agent-ready") != null' >/dev/null; then
            has_ready="true"
          fi

          should_dispatch="false"
          reason="gate-not-satisfied"

          if [ "$mode" = "manual" ]; then
            if [ "$action" = "labeled" ] && [ "$labeled_name" = "agent-run" ] && [ "$has_task" = "true" ] && [ "$has_ready" = "true" ]; then
              should_dispatch="true"
              reason="manual:agent-run-labeled"
            fi
          else
            if [ "$action" = "labeled" ] && [ "$labeled_name" = "agent-ready" ] && [ "$has_task" = "true" ]; then
              should_dispatch="true"
              reason="auto:agent-ready-labeled"
            elif [ "$action" = "reopened" ] && [ "$has_task" = "true" ] && [ "$has_ready" = "true" ]; then
              should_dispatch="true"
              reason="auto:issue-reopened"
            fi
          fi

          event_fingerprint="$(jq -c \
            '{action:(.action // ""), issue_number:(.issue.number // 0), issue_updated_at:(.issue.updated_at // ""), label:(.label.name // ""), sender:(.sender.login // ""), labels:([.issue.labels[].name] // [])}' \
            "$GITHUB_EVENT_PATH" | sha256sum | awk '{print $1}')"
          request_id="issue-event-${event_fingerprint}"

          {
            echo "mode=${mode}"
            echo "action=${action}"
            echo "labeled_name=${labeled_name}"
            echo "has_task=${has_task}"
            echo "has_ready=${has_ready}"
            echo "should_dispatch=${should_dispatch}"
            echo "reason=${reason}"
            echo "request_id=${request_id}"
          } >> "$GITHUB_OUTPUT"

      - name: Validate dispatch token
        if: ${{ steps.gate.outputs.should_dispatch == 'true' }}
        run: |
          if [ -z "${{ secrets.FLOW_SMITH_DISPATCH_TOKEN }}" ]; then
            echo "Secret FLOW_SMITH_DISPATCH_TOKEN is required." >&2
            exit 1
          fi

      - name: Send repository_dispatch to FlowSmith
        if: ${{ steps.gate.outputs.should_dispatch == 'true' }}
        env:
          FLOW_SMITH_DISPATCH_TOKEN: ${{ secrets.FLOW_SMITH_DISPATCH_TOKEN }}
          FLOW_SMITH_DISPATCH_SECRET: ${{ secrets.FLOW_SMITH_DISPATCH_SECRET }}
          FLOW_SMITH_CODEX_AUTH_JSON_B64: ${{ secrets.FLOW_SMITH_CODEX_AUTH_JSON_B64 || '' }}
        run: |
          set -euo pipefail

          owner="${FLOW_SMITH_REPO%%/*}"
          repo="${FLOW_SMITH_REPO##*/}"

          payload="$(jq -n \
            --argjson issue_number "${{ github.event.issue.number }}" \
            --arg target_repo "${{ github.repository }}" \
            --arg base_branch "${{ github.event.repository.default_branch }}" \
            --arg project_id "${FLOW_SMITH_PROJECT_ID}" \
            --arg source_repository "${{ github.repository }}" \
            --arg request_id "${{ steps.gate.outputs.request_id }}" \
            --arg dispatch_secret "${FLOW_SMITH_DISPATCH_SECRET:-}" \
            --arg codex_auth_json_b64 "${FLOW_SMITH_CODEX_AUTH_JSON_B64:-}" \
            '{
              event_type: "autonomous-agent-issue-request",
              client_payload: (
                {
                  issue_number: $issue_number,
                  target_repo: $target_repo,
                  base_branch: $base_branch,
                  source_repository: $source_repository,
                  request_id: $request_id,
                  dispatch_secret: $dispatch_secret
                } + (if $project_id != "" then {project_id: $project_id} else {} end) + (if $codex_auth_json_b64 != "" then {codex_auth_json_b64: $codex_auth_json_b64} else {} end)
              )
            }')"

          curl -fsSL -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${FLOW_SMITH_DISPATCH_TOKEN}" \
            "https://api.github.com/repos/${owner}/${repo}/dispatches" \
            -d "${payload}"

      - name: Summary
        if: ${{ always() }}
        run: |
          {
            echo "## FlowSmith Issue Trigger Result"
            echo ""
            echo "- gate_mode: \`${{ steps.gate.outputs.mode }}\`"
            echo "- gate_reason: \`${{ steps.gate.outputs.reason }}\`"
            echo "- should_dispatch: \`${{ steps.gate.outputs.should_dispatch }}\`"
            echo "- issue_has_agent_task: \`${{ steps.gate.outputs.has_task }}\`"
            echo "- issue_has_agent_ready: \`${{ steps.gate.outputs.has_ready }}\`"
            echo "- flow_smith_repo: \`${FLOW_SMITH_REPO}\`"
            echo "- flow_smith_project_id: \`${FLOW_SMITH_PROJECT_ID:-未設定}\`"
            echo "- source_repo: \`${{ github.repository }}\`"
            echo "- issue_number: \`${{ github.event.issue.number }}\`"
            echo "- request_id: \`${{ steps.gate.outputs.request_id }}\`"
          } >> "$GITHUB_STEP_SUMMARY"
